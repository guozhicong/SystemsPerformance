> [!NOTE]
>
> **Hypervisor（虚拟化管理程序）**： 虚拟化技术中，Hypervisor 分为两类：
>
> - **Type-1 裸金属型**：直接运行在物理硬件上，不依赖操作系统，比如 VMware ESXi、Xen 的裸金属模式。
> - **Type-2 宿主型**：运行在宿主操作系统之上，比如 VirtualBox、VMware Workstation。

# 虚拟机部署

## 简介

KVM是一种虚拟化 架构，由Linux内核提供支持，它能够将内核作为Hypervisor直接运行，不需要额外的模拟。KVM通过内核模块kvm.ko来实现核心虚拟化功能，并与处理器紧密相关的模块（如kvm-amd.ko）配合使用。KVM本身不实现任何模拟，它仅暴露了一个/dev/kvm接口，通过这个接口，宿主机可以创建vCPU、分配虚拟内存地址空间、读写vCPU寄存器以及运行vCPU。使用KVM后，Guest OS的CPU指令可以直接运行，无需经过QEMU的转译，从而大大提高了运行速度。

KVM实现了CPU和内存的虚拟化，但KVM并不能模拟其他设备，需要一个运行在用户空间的工具来实现完整的虚拟化。为了实现这一目标，KVM的开发者选择了成熟的开源虚拟化软件QEMU来作为这个工具，并对其进行了改进，使其能够模拟IO设备（如网卡和磁盘）。这样，QEMU-KVM就成为了一种完整的虚拟化解决方案。

在QEMU-KVM中，KVM运行在内核空间。QEMU运行在用户空间，实际模拟创建、管理各种虚拟硬件。通过ioctl调用“/dev/kvm”，QEMU将KVM整合进来，从而将CPU指令的部分交给内核模块来做。KVM实现了CPU和内存的虚拟化，但KVM不能虚拟化其他硬件设备，因此QEMU还有模拟IO设备（如磁盘、网卡和显卡等）的作用，KVM加上QEMU后就是完整意义上的服务器虚拟化。

## 软硬件配置

| 配置/名称 | 型号/版本                                          |
| --------- | -------------------------------------------------- |
| 主机型号  | TS200-2280 V2                                      |
| CPU       | 2 * Kunpeng 920 7280Z                              |
| 内存      | DDR5 14 * 32GB 4800 MT/s                           |
| 磁盘      | 12 * 7T NVMe SSD (数据盘) + 1 * 512GB SSD (系统盘) |
| OS        | openEuler 22.03 (LTS-SP4)                          |
| 内核      | 5.10.0-216.0.0.115.oe2203sp4.aarch64               |

## 部署

1. 配置BIOS

   | BIOS配置项   | 选项含义                                                     | 建议配置值 | 修改路径                                     |
   | ------------ | ------------------------------------------------------------ | ---------- | -------------------------------------------- |
   | SRIOV        | 启用或禁用Single Root Input/Output Virtualization（SRIOV）。 | Enabled    | BIOS > Advanced > PCIe Config > SRIOV        |
   | Support Smmu | 启用或禁用SMMU功能。                                         | Enabled    | BIOS > Advanced > MISC Config > Support Smmu |

2. 安装虚拟化相关组件

   ```shell
   # 安装QEMU作为虚拟机模拟器，安装libvirt用于管理虚拟化平台的开源的API、后台程序和管理工具。
   
   # 安装虚拟化相关组件
   yum install libvirt qemu edk2-aarch64.noarch virt-install -y
   # 启动libvirtd服务并设置开机自启动。
   systemctl start libvirtd
   systemctl enable libvirtd
   # 查看QEMU版本，确认QEMU版本与环境要求一致。
   qemu-kvm --version
   # 查看libvirt版本，确认libvirt版本与环境要求一致。 
   libvirtd --version
   
   # 检查libvirt服务。
   systemctl status libvirtd
   # 查看版本信息。
   virsh version
   
   ```

3. 创建虚拟机

   > [!NOTE]
   >
   > 虚拟机分配的磁盘空间不能低于qcow2格式镜像的虚拟磁盘大小，否则会导致创建虚拟机失败。镜像的虚拟磁盘大小查询命令如下，openEuler-22.03-LTS-SP3-aarch64.qcow2 为镜像文件名称，查询结果中的virtual size即为镜像的虚拟磁盘大小。
   >
   > qemu-img info openEuler-22.03-LTS-SP3-aarch64.qcow2
   >
   > ![image-20260102233442261](/Users/guozhicong/Library/Application Support/typora-user-images/image-20260102233442261.png)
   >
   > 因为qcow2格式镜像分区已经固定，如果虚拟机分配的磁盘空间大于qcow2格式镜像的虚拟磁盘大小，多余空间需要手动分区或者给已有分区扩容才能使用。

   

   - 使用已有qcow2格式镜像创建虚拟机

   ```shell
   # 上传镜像到“/home/kvm/images”目录下并解压。
   
   mkdir -p /home/kvm/images
   cd /home/kvm/images/
   wget https://dl-cdn.openeuler.openatom.cn/openEuler-22.03-LTS-SP4/virtual_machine_img/aarch64/openEuler-22.03-LTS-SP4-aarch64.qcow2.xz
   xz -d openEuler-22.03-LTS-SP4-aarch64.qcow2.xz
   
   # 创建虚拟机vm2，虚拟机分配16个vCPU、120G内存、40GB磁盘空间，执行如下命令创建虚拟机。
   virt-install --name=vm2 --vcpus=16 --ram=122880  --disk path=/home/kvm/images/openEuler-22.03-LTS-SP4-aarch64.qcow2,format=qcow2,size=40,bus=virtio --boot hd --network network=default --force --autostart
   # 虚拟机初始账号密码为root/openEuler12#$
   ```

4. 运行和验证

   ```shell
   # 查询当前已启动的虚拟机
   [root@hostname-pvh0q images]# virsh list --all 
    Id   Name   State
   ----------------------
    1    vm2    running
   
   # 打开虚拟机
   [root@hostname-pvh0q images]# virsh console vm2 
   Connected to domain vm2
   Escape character is ^] (Ctrl + ])
   
   # 修改虚拟机配置文件
   [root@hostname-pvh0q images]# virsh edit vm2
   ```

   

## 参考

[QEMU-KVM虚拟机 安装指南（openEuler 22.03）](https://www.hikunpeng.com/document/detail/zh/kunpengcpfs/ecosystemEnable/QEMU-KVM/kunpengqemukvm_03_0001.html)

